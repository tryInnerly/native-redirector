# Web Redirector

Промежуточная страница для принудительного открытия сайта в нативном браузере вместо встроенного WebView социальных сетей (Instagram, Facebook, TikTok и др.).

## Зачем это нужно

Реклама в Instagram/Facebook/TikTok открывает ссылки во встроенном браузере (WebView). Это ломает:

- Формы оплаты (Stripe, банковские 3DS)
- OAuth-авторизацию (Google, Apple Sign-In)
- Сохранённые пароли и автозаполнение
- Корректную работу cookies и localStorage
- Аналитику и атрибуцию (пиксели, UTM)

Результат — падение конверсии на 15-40%.

## Как работает

```
Пользователь кликает рекламу
        │
        ▼
  Открывается WebView
        │
        ▼
  index.html определяет тип браузера по User-Agent
        │
        ├── Нативный браузер → показываем "Всё ОК", ничего не делаем
        │
        ├── Android WebView → пытаемся открыть через Intent URI
        │   │                  через 1.5с показываем ручную инструкцию
        │   │
        │   └── Фоллбэк: кнопка "Скопировать ссылку"
        │
        └── iOS WebView → пытаемся x-safari-https:// (автоматический редирект)
            │                через 1.5с показываем инструкцию "Нажми ··· → Открыть в Safari"
            │                с анимированной стрелкой на кнопку меню
            │
            └── Фоллбэк: кнопка "Скопировать ссылку"
```

## Использование

Поставь `index.html` как landing page для рекламного трафика. На реальном проекте добавь редирект на целевой URL после успешного открытия в нативном браузере.

### Параметр целевого URL

Для продакшн-использования нужно добавить параметр `?url=https://your-site.com` и редирект на него после определения нативного браузера. Текущая версия — демо без редиректа.

---

## Состояние технологии по платформам

### Android

**Статус: решаемо**

На Android есть надёжный механизм — **Intent URI**. Это стандарт Android, который позволяет из WebView открыть URL в системном браузере по умолчанию.

```
intent://example.com/path#Intent;scheme=https;action=android.intent.action.VIEW;S.browser_fallback_url=https%3A%2F%2Fexample.com%2Fpath;end;
```

| Параметр | Значение |
|----------|----------|
| `scheme=https` | Протокол целевого URL |
| `action=android.intent.action.VIEW` | Системное действие "открыть" |
| `S.browser_fallback_url=...` | Куда перейти, если Intent не сработал |

**Что важно знать:**

- **Не указывайте `package=com.android.chrome`** — это привязывает к Chrome. Без `package` Android откроет URL в браузере по умолчанию (Samsung Browser, Xiaomi Browser, Firefox и т.д.)
- Chrome блокирует Intent без жеста пользователя — автоматический `window.location.replace()` может не сработать, поэтому нужна кнопка как фоллбэк
- Некоторые WebView (TikTok) могут блокировать `intent://` — на этот случай есть ручная инструкция

**Что НЕ работает на Android:**

| Метод | Почему не работает |
|-------|-------------------|
| `googlechrome://` | Устаревшая схема, Google рекомендует Intent URI |
| `window.open(url, '_blank')` | Открывает в том же WebView |
| `target="_blank"` на ссылках | Открывает в том же WebView |
| `window.open(url, '_system')` | Не поддерживается в WKWebView/WebView |
| HTTP 302 редирект | Навигация внутри WebView |
| `<meta http-equiv="refresh">` | Навигация внутри WebView |

**Покрытие:** ~70-80% пользователей Android успешно редиректятся через Intent URI.

---

### iOS

**Статус: нет надёжного программного решения**

Apple целенаправленно закрывает все лазейки для выхода из WKWebView. Надёжного способа нет, но есть частично работающий метод.

**Что мы используем:**

#### 1. `x-safari-https://` (автоматическая попытка)

```js
window.location.replace('x-safari-https://example.com');
```

Safari регистрирует эту URL-схему в своём `Info.plist`. Когда WebView встречает незнакомую схему, он может передать её системе через `UIApplication.open()`. iOS показывает системный диалог *"[Приложение] хочет открыть Safari"* → при подтверждении открывает Safari.

| iOS версия | Статус |
|------------|--------|
| iOS 15 | Работает |
| iOS 16 | Не работает |
| iOS 17 | Работает |
| iOS 18 | Работает (может измениться) |

**Ограничения:**
- Недокументированная схема — Apple может убрать в любом обновлении
- Зависит от того, пропускает ли хост-приложение (Instagram) незнакомые схемы в `UIApplication.open()` — Instagram может заблокировать
- В TikTok работает стабильнее, чем в Instagram

#### 2. Ручная инструкция (фоллбэк через 1.5 секунды)

Если `x-safari-https://` не сработал, показываем пошаговую инструкцию с анимированной стрелкой, адаптированную под конкретное приложение.

В Instagram, Facebook, TikTok и других приложениях есть встроенная кнопка "Открыть в браузере" (обычно через меню `···` или `⋮`). Наша задача — максимально понятно объяснить пользователю, как её нажать.

**Методы, которые НЕ работают:**

| Метод | Почему не работает |
|-------|-------------------|
| `x-web-search://?site:URL` | Открывает поисковый запрос, а не URL. На iOS 16.4+ нестабильна |
| `shortcuts://x-callback-url/...` | Был лучшим методом до осени 2024. Сломан на iOS 18.1+ |
| `googlechrome://URL` | Требует установленный Chrome. Большинство пользователей iOS используют Safari |
| `firefox://open-url?url=URL` | Требует установленный Firefox |
| `window.open(url, '_blank')` | Открывает в том же WebView |
| HTTP 302 / `<meta refresh>` | Навигация внутри WebView |

**Почему iOS — сложный случай:**

- Instagram/Facebook используют **WKWebView** — Apple даёт хост-приложению полный контроль над ним
- WKWebView изолирован от Safari: не разделяет cookies, историю, сохранённые пароли
- Apple не предоставляет API для "открыть URL в Safari" из WKWebView
- Каждая лазейка через URL-схемы закрывается в следующих обновлениях iOS

**Как работают коммерческие сервисы (InAppRedirect и др.):**

Никакой магии — они делают то же самое: `x-safari-https://` + consent-страница + инструкция. Их "~70% success rate" — это процент пользователей, которые нажали кнопку на consent-странице, а не автоматических редиректов.

| Приложение | Где кнопка меню | Что нажать |
|------------|----------------|------------|
| Instagram | `···` справа вверху | "Открыть в браузере" |
| Facebook | `⋮` справа вверху | "Открыть в браузере" |
| TikTok | `···` справа вверху | "Открыть в браузере" |
| Telegram | `···` справа вверху | "Открыть в Safari" |
| Snapchat | `···` справа вверху | "Открыть в браузере" |

**Покрытие:** зависит от того, сколько пользователей выполнят инструкцию. По данным InAppRedirect — ~50-60%.

---

### Сравнение WKWebView и SFSafariViewController

Не все in-app браузеры одинаковы:

| | WKWebView | SFSafariViewController |
|---|-----------|----------------------|
| **Используют** | Instagram, Facebook, TikTok | Twitter/X, некоторые банки |
| **JS-инъекции хост-приложением** | Да (Meta инъектирует `pcm.js`) | Нет (песочница) |
| **Cookies общие с Safari** | Нет | Нет (с iOS 11) |
| **Определение по UA** | Легко — нет токена `Safari` или есть токен приложения | Сложно — выглядит как обычный Safari |
| **Кнопка "Открыть в Safari"** | Зависит от приложения | Встроенная |
| **Безопасность** | Низкая — приложение видит всё | Высокая — песочница |

Twitter/X использует SFSafariViewController — он безопаснее и обычно не ломает формы оплаты, поэтому редирект из него менее критичен.

---

### Универсальный фоллбэк: копирование ссылки

Если ничего не сработало, пользователь может скопировать ссылку и вставить в браузер. Три уровня:

1. **`navigator.clipboard.writeText()`** — современный API, работает на iOS, может не работать в Android WebView
2. **`document.execCommand('copy')`** — устаревший, но поддерживается везде
3. **`window.prompt()`** — последний рубеж, показывает URL для ручного копирования

---

## Детекция in-app браузеров

Определение работает по строкам в User-Agent:

| Приложение | Паттерны в UA |
|------------|--------------|
| Instagram | `Instagram` |
| Facebook | `FBAN`, `FBAV`, `FB_IAB`, `FB4A` |
| TikTok | `TikTok`, `BytedanceWebview`, `musical_ly`, `trill` |
| Twitter/X | `Twitter` |
| Snapchat | `Snapchat` |
| Pinterest | `Pinterest` |
| LinkedIn | `LinkedInApp` |
| Telegram | `Telegram` |
| Line | `Line/` |
| WeChat | `MicroMessenger` |

**Generic WebView (если конкретное приложение не определено):**

| Платформа | Признак |
|-----------|---------|
| Android | `wv)` в UA + `Android` |
| Android (старый) | `Android.*Version/[0-9]` |
| iOS | `iPhone\|iPad` в UA, но нет `Safari` |
| Любая | `WebView` в UA |

---

## Коммерческие альтернативы

| Сервис | Подход | Цена |
|--------|--------|------|
| [InAppRedirect](https://www.inappredirect.com/) | JS-скрипт, чёрный ящик. Заявляют ~70% редиректов | SaaS, платный |
| [URLgenius](https://app.urlgeni.us/) | Платформа диплинков, замена Firebase Dynamic Links | SaaS, платный |
| [Branch.io](https://branch.io/) | Enterprise диплинки с SDK | Enterprise |

---

## Ограничения

- На iOS нет программного способа открыть Safari — только инструкция для пользователя
- На Android Intent URI может быть заблокирован некоторыми WebView
- Clipboard API может не работать без HTTPS
- Детекция по User-Agent не на 100% надёжна — приложения могут менять формат UA

## Структура

```
web-redirector/
└── index.html    — единый файл, без зависимостей
```
